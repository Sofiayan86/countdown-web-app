<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重要日子倒數</title>
    
    <!-- React 和相關庫 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.4/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PWA 設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="重要日子倒數">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        button { min-height: 44px; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(to bottom right, #f8fafc, #e0e7ff, #c7d2fe);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #dc2626;
            background: #fee2e2;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root">
        <div id="loading">
            <div style="text-align: center;">
                <div style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 20px; color: #6b7280;">載入中...</p>
                <p id="loadingStatus" style="margin-top: 10px; color: #9ca3af; font-size: 12px;">正在初始化應用程式</p>
            </div>
        </div>
    </div>

    <script>
        // 載入狀態更新
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        // 錯誤處理
        function showError(message) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="error-message">
                    <h2>載入失敗</h2>
                    <p>${message}</p>
                    <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        重新載入
                    </button>
                </div>
            `;
        }

        // 檢查必要的庫是否載入
        function checkLibraries() {
            updateLoadingStatus('檢查必要庫...');
            
            if (typeof React === 'undefined') {
                throw new Error('React 未載入');
            }
            if (typeof ReactDOM === 'undefined') {
                throw new Error('ReactDOM 未載入');
            }
            if (typeof Babel === 'undefined') {
                throw new Error('Babel 未載入');
            }
            if (typeof lucideReact === 'undefined') {
                throw new Error('Lucide React 未載入');
            }
            
            updateLoadingStatus('所有庫載入成功');
        }

        // 等待所有資源載入完成
        window.addEventListener('load', () => {
            try {
                setTimeout(() => {
                    checkLibraries();
                    updateLoadingStatus('啟動應用程式...');
                    
                    // 轉換並執行 React 代碼
                    const scriptContent = `
                        const { useState, useEffect, useRef } = React;
                        const { 
                            Plus, Heart, Star, Gift, Trash2, Clock, Pin, Upload, X, RotateCcw, 
                            BarChart3, Camera, TrendingUp, List, Download, Share2, MessageCircle, 
                            Send, Copy, ExternalLink 
                        } = lucideReact;

                        function CountdownWebApp() {
                            const fileInputRef = useRef(null);
                            
                            const [events, setEvents] = useState([
                                {
                                    id: 1,
                                    name: '新年',
                                    date: '2026-01-01',
                                    type: 'holiday',
                                    color: 'from-red-500 to-red-600',
                                    isPinned: true,
                                    customImage: 'https://images.unsplash.com/photo-1467810563316-b5476525c0f9?w=600&h=300&fit=crop'
                                },
                                {
                                    id: 2,
                                    name: '我的生日',
                                    date: '2025-08-15',
                                    type: 'birthday',
                                    color: 'from-pink-500 to-pink-600',
                                    isPinned: true,
                                    customImage: 'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=600&h=300&fit=crop'
                                }
                            ]);
                            
                            const [showShareModal, setShowShareModal] = useState(false);
                            const [shareEvent, setShareEvent] = useState(null);
                            const [currentView, setCurrentView] = useState('events');
                            const [dateFormat, setDateFormat] = useState('days');
                            const [timeLefts, setTimeLefts] = useState({});

                            const eventTypes = {
                                birthday: { icon: Gift, label: '生日', color: 'from-pink-500 to-pink-600' },
                                holiday: { icon: Star, label: '節日', color: 'from-red-500 to-red-600' },
                                anniversary: { icon: Heart, label: '紀念日', color: 'from-purple-500 to-purple-600' },
                                other: { icon: List, label: '其他', color: 'from-blue-500 to-blue-600' }
                            };

                            const calculateTimeLeft = (targetDate) => {
                                const now = new Date().getTime();
                                const target = new Date(targetDate).getTime();
                                const difference = target - now;

                                if (difference <= 0) {
                                    const pastDays = Math.floor(Math.abs(difference) / (1000 * 60 * 60 * 24));
                                    return { 
                                        days: 0, 
                                        isPast: true,
                                        pastDays: pastDays
                                    };
                                }

                                const futureDays = Math.floor(difference / (1000 * 60 * 60 * 24));
                                return {
                                    days: futureDays,
                                    isPast: false,
                                    pastDays: 0
                                };
                            };

                            const formatDate = (dateString) => {
                                const date = new Date(dateString);
                                return date.toLocaleDateString('zh-TW', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    weekday: 'long'
                                });
                            };

                            useEffect(() => {
                                const timer = setInterval(() => {
                                    const newTimeLefts = {};
                                    events.forEach(event => {
                                        newTimeLefts[event.id] = calculateTimeLeft(event.date);
                                    });
                                    setTimeLefts(newTimeLefts);
                                }, 60000);

                                const initialTimeLefts = {};
                                events.forEach(event => {
                                    initialTimeLefts[event.id] = calculateTimeLeft(event.date);
                                });
                                setTimeLefts(initialTimeLefts);

                                return () => clearInterval(timer);
                            }, [events]);

                            const shareAppToSocial = (platform) => {
                                const appTitle = '重要日子倒數 Web App';
                                const appDescription = '一個簡潔優雅的倒數計時應用，幫你記錄生命中的重要時刻 ⏰✨';
                                const baseUrl = window.location.href;
                                const fullText = \`\${appDescription}\\n\\n🔗 \${baseUrl}\\n\\n#倒數計時 #重要日子 #時間管理 #生活記錄\`;
                                
                                let shareUrl = '';
                                
                                switch (platform) {
                                    case 'twitter':
                                        shareUrl = \`https://twitter.com/intent/tweet?text=\${encodeURIComponent(fullText)}\`;
                                        break;
                                    case 'facebook':
                                        shareUrl = \`https://www.facebook.com/sharer/sharer.php?u=\${encodeURIComponent(baseUrl)}&quote=\${encodeURIComponent(appDescription)}\`;
                                        break;
                                    case 'copy':
                                        navigator.clipboard.writeText(fullText);
                                        alert('應用分享內容已複製到剪貼板！');
                                        return;
                                    default:
                                        return;
                                }
                                
                                if (shareUrl) {
                                    window.open(shareUrl, '_blank', 'width=600,height=400');
                                }
                            };

                            const closeShareModal = () => {
                                setShowShareModal(false);
                                setShareEvent(null);
                            };

                            const pinnedEvents = events.filter(event => event.isPinned).slice(0, 3);
                            const stats = {
                                total: events.length,
                                future: events.filter(event => new Date(event.date) > new Date()).length,
                                past: events.filter(event => new Date(event.date) <= new Date()).length
                            };

                            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100" },
                                React.createElement('div', { className: "flex" },
                                    React.createElement('div', { className: "flex-1 p-6 max-w-6xl mx-auto" },
                                        // 標題區域
                                        React.createElement('div', { className: "text-center mb-12" },
                                            React.createElement('div', { className: "inline-flex items-center gap-4 mb-6" },
                                                React.createElement('div', { className: "p-4 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-lg" },
                                                    React.createElement(Clock, { className: "text-white", size: 32 })
                                                ),
                                                React.createElement('h1', { className: "text-5xl font-black text-gray-800 tracking-tight" }, "重要日子倒數")
                                            ),
                                            React.createElement('p', { className: "text-xl text-gray-600 mb-8" }, "記錄並倒數你生命中的重要時刻"),
                                            
                                            React.createElement('div', { className: "mb-4 px-4 py-2 bg-green-100 border-l-4 border-green-500 rounded-lg" },
                                                React.createElement('p', { className: "text-sm text-green-700" },
                                                    React.createElement('strong', {}, "成功！"),
                                                    " 應用程式已成功載入並運行。"
                                                )
                                            ),
                                            
                                            React.createElement('div', { className: "flex items-center justify-center gap-4 mb-8" },
                                                React.createElement('button', {
                                                    onClick: () => setCurrentView('events'),
                                                    className: \`px-4 py-2 rounded-xl font-medium transition-all duration-200 \${currentView === 'events' ? 'bg-blue-500 text-white' : 'bg-white/80 text-gray-600'}\`
                                                }, "事件列表"),
                                                React.createElement('button', {
                                                    onClick: () => setCurrentView('stats'),
                                                    className: \`px-4 py-2 rounded-xl font-medium transition-all duration-200 \${currentView === 'stats' ? 'bg-blue-500 text-white' : 'bg-white/80 text-gray-600'}\`
                                                }, "統計分析"),
                                                React.createElement('button', {
                                                    onClick: () => setShowShareModal(true),
                                                    className: "p-2 bg-white/80 hover:bg-white text-gray-600 hover:text-blue-600 rounded-lg transition-all duration-200"
                                                }, React.createElement(Share2, { size: 18 }))
                                            )
                                        ),
                                        
                                        // 事件列表
                                        currentView === 'events' && React.createElement('div', { className: "max-w-4xl mx-auto space-y-4" },
                                            events.map(event => {
                                                const timeLeft = timeLefts[event.id] || calculateTimeLeft(event.date);
                                                const EventIcon = eventTypes[event.type].icon;
                                                
                                                return React.createElement('div', {
                                                    key: event.id,
                                                    className: "flex items-center gap-4 p-4 bg-white rounded-2xl shadow-md border-l-4",
                                                    style: { borderLeftColor: '#3b82f6' }
                                                },
                                                    React.createElement('div', { className: "flex-shrink-0" },
                                                        event.customImage ? 
                                                            React.createElement('div', {
                                                                className: "w-16 h-16 bg-cover bg-center rounded-xl border-2 border-gray-200",
                                                                style: { backgroundImage: \`url(\${event.customImage})\` }
                                                            }) :
                                                            React.createElement('div', {
                                                                className: \`w-16 h-16 bg-gradient-to-br \${event.color} rounded-xl flex items-center justify-center\`
                                                            }, React.createElement(EventIcon, { size: 24, className: "text-white" }))
                                                    ),
                                                    React.createElement('div', { className: "flex-1" },
                                                        React.createElement('h3', { className: "text-lg font-bold text-gray-800" }, event.name),
                                                        React.createElement('p', { className: "text-sm text-gray-500" }, formatDate(event.date))
                                                    ),
                                                    React.createElement('div', { className: "text-right" },
                                                        React.createElement('div', {
                                                            className: \`text-3xl font-bold \${timeLeft.isPast ? 'text-gray-400' : 'text-blue-600'}\`
                                                        }, \`\${timeLeft.isPast ? timeLeft.pastDays : timeLeft.days} 天\`)
                                                    )
                                                );
                                            })
                                        ),
                                        
                                        // 統計視圖
                                        currentView === 'stats' && React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
                                            React.createElement('div', { className: "bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white text-center" },
                                                React.createElement('div', { className: "text-3xl font-bold mb-2" }, stats.total),
                                                React.createElement('div', { className: "text-sm" }, "總事件數")
                                            ),
                                            React.createElement('div', { className: "bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-white text-center" },
                                                React.createElement('div', { className: "text-3xl font-bold mb-2" }, stats.future),
                                                React.createElement('div', { className: "text-sm" }, "未來事件")
                                            ),
                                            React.createElement('div', { className: "bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl text-white text-center" },
                                                React.createElement('div', { className: "text-3xl font-bold mb-2" }, stats.past),
                                                React.createElement('div', { className: "text-sm" }, "已過事件")
                                            )
                                        )
                                    )
                                ),
                                
                                // 分享模態框
                                showShareModal && React.createElement('div', { className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" },
                                    React.createElement('div', { className: "bg-white rounded-2xl max-w-md w-full p-6" },
                                        React.createElement('div', { className: "flex items-center justify-between mb-4" },
                                            React.createElement('h3', { className: "text-xl font-bold" }, "分享應用"),
                                            React.createElement('button', {
                                                onClick: closeShareModal,
                                                className: "p-2 hover:bg-gray-100 rounded-lg"
                                            }, React.createElement(X, { size: 20 }))
                                        ),
                                        React.createElement('div', { className: "grid grid-cols-2 gap-3" },
                                            React.createElement('button', {
                                                onClick: () => shareAppToSocial('twitter'),
                                                className: "flex items-center gap-3 p-3 bg-blue-50 text-blue-600 rounded-xl"
                                            }, "Twitter"),
                                            React.createElement('button', {
                                                onClick: () => shareAppToSocial('facebook'),
                                                className: "flex items-center gap-3 p-3 bg-blue-50 text-blue-800 rounded-xl"
                                            }, "Facebook"),
                                            React.createElement('button', {
                                                onClick: () => shareAppToSocial('copy'),
                                                className: "flex items-center gap-3 p-3 bg-gray-50 text-gray-700 rounded-xl"
                                            }, "複製連結")
                                        )
                                    )
                                ),
                                
                                React.createElement('div', { className: "fixed bottom-4 left-4 bg-white/90 rounded-lg px-3 py-2 text-xs text-gray-600" },
                                    "📱 Web App v1.0"
                                )
                            );
                        }

                        ReactDOM.render(React.createElement(CountdownWebApp), document.getElementById('root'));
                    `;

                    // 使用 Babel 轉換代碼
                    const transformedCode = Babel.transform(scriptContent, {
                        presets: ['react']
                    }).code;

                    // 執行轉換後的代碼
                    eval(transformedCode);
                    
                }, 1000);
            } catch (error) {
                console.error('載入錯誤:', error);
                showError(error.message || '未知錯誤');
            }
        });

        // 全域錯誤處理
        window.addEventListener('error', (event) => {
            console.error('全域錯誤:', event.error);
            showError('應用程式遇到錯誤: ' + event.error.message);
        });
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('Service Worker 註冊失敗:', err);
                });
            });
        }
    </script>
</body>
</html>
